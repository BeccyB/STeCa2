Taken from branch adhoc; minimal changes.
